function grph_axis_chloropleth(){function t(){}var n,e,r,i=grph_scale_chloropleth();return t.width=function(t){return 0===arguments.length?e:(e=t,this)},t.height=function(t){return 0===arguments.length?r:(r=t,this)},t.accept=function(t,n){var e=variable_schema(t,n);return"number"==e.type},t.variable=function(t){return 0===arguments.length?n:(n=t,this)},t.domain=function(t){return 0===arguments.length?i.domain():void 0===n?this:(i.domain(d3.extent(t,function(t){return t[n]})),this)},t.ticks=function(){return i.ticks()},t.scale=function(e){return"object"==typeof e?t.scale(e[n]):i(e)},t}
function grph_axis_colour(){function t(){}var n,r,e,i=grph_scale_colour();return t.width=function(t){return 0===arguments.length?r:(r=t,this)},t.height=function(t){return 0===arguments.length?e:(e=t,this)},t.accept=function(t,n){var r=variable_schema(t,n);return"categorical"==r.type},t.variable=function(t){return 0===arguments.length?n:(n=t,this)},t.domain=function(t,r){if(0===arguments.length)return i.domain();if(void 0===n)return this;var e=variable_schema(n,r),a=e.categories.map(function(t){return t.name});return i.domain(a),this},t.ticks=function(){return i.ticks()},t.scale=function(t){return i("object"==typeof t?t[n]:t)},t}
function grph_axis_linear(t){function e(n){var a=e.ticks();if(n.append("rect").attr("class","background").attr("width",e.width()).attr("height",e.height()),t)n.selectAll(".tick").data(a).enter().append("line").attr("class","tick").attr("x1",r).attr("x2",r).attr("y1",0).attr("y2",c.tick_length),n.selectAll(".ticklabel").data(a).enter().append("text").attr("class","ticklabel").attr("x",r).attr("y",c.tick_length+c.tick_padding).text(function(t){return t}).attr("text-anchor","middle").attr("dy","0.71em");else{var i=e.width();n.selectAll(".tick").data(a).enter().append("line").attr("class","tick").attr("x1",i-c.tick_length).attr("x2",i).attr("y1",r).attr("y2",r),n.selectAll(".ticklabel").data(a).enter().append("text").attr("class","ticklabel").attr("x",c.padding).attr("y",r).text(function(t){return t}).attr("text-anchor","begin").attr("dy","0.35em")}}var n,a,i,r=grph_scale_linear(),l=t,c={tick_length:5,tick_padding:2,padding:4},d=d3.select("body").append("svg").attr("class","linearaxis dummy").style("visibility","invisible"),s=grph_label_size(d);return r.label_size(l?s.width:s.height),e.width=function(t){if(l)return 0===arguments.length?a:(a=t,r.range([0,a]),this);if(0===arguments.length){if(void 0===a){for(var e=r.ticks(),n=0,i=0;i<e.length;++i){var d=s.width(e[i]);d>n&&(n=d)}a=n+c.tick_length+c.tick_padding+c.padding}return a}return a=t,this},e.height=function(t){if(l){if(0===arguments.length){if(void 0===i){for(var e=r.ticks(),n=0,a=0;a<e.length;++a){var d=s.height(e[a]);d>n&&(n=d)}i=n+c.tick_length+c.tick_padding+c.padding}return i}return i=t,this}return 0===arguments.length?i:(i=t,r.range([i,0]),this)},e.accept=function(t,e){var n=variable_schema(t,e);return"number"==n.type},e.variable=function(t){return 0===arguments.length?n:(n=t,this)},e.domain=function(t){if(0===arguments.length)return r.domain();var e=d3.extent(t,function(t){return t[n]});return r.domain(e).nice(),this},e.ticks=function(){return r.ticks()},e.scale=function(t){return r("object"==typeof t?t[n]:t)},e}
function grph_axis_region(){function t(){}function e(t,e,a){if(void 0!==n){var r=variable_schema(n,e);void 0!==r.map&&r.map!=i&&(c=!0,d3.json(r.map,function(t){i=r.map,a(t),c=!1}))}}var n,a,r,i,o,u={};t.width=function(t){return 0===arguments.length?a:(s=s||a!=t,a=t,this)},t.height=function(t){return 0===arguments.length?r:(s=s||r!=t,r=t,this)},t.accept=function(t,e){var n=variable_schema(t,e);return"string"==n.type},t.variable=function(t){return 0===arguments.length?n:(n=t,this)};var c=!1;t.map_loaded=function(){return!c},t.domain=function(t,a){return 0!==arguments.length?(e(t,a,function(t){o=t,s=!0;var e=variable_schema(n,a),r=e.regionid||"id";for(var i in o.features){var c=o.features[i].properties[r];u[c]=i}}),this):void 0},t.scale=function(e){return"object"==typeof e?t.scale(e[n]):(t.update_projection(),p(o.features[u[e]]))};var s=!0,f=d3.geo.transverseMercator().rotate([-5.38720621,-52.1551744]).scale(1).translate([0,0]),p=d3.geo.path().projection(f);return t.update_projection=function(){if(s&&o){f.scale(1).translate([0,0]),p=d3.geo.path().projection(f);var t=p.bounds(o),e=.95/Math.max((t[1][0]-t[0][0])/a,(t[1][1]-t[0][1])/r),n=[(a-e*(t[1][0]+t[0][0]))/2,(r-e*(t[1][1]+t[0][1]))/2];f.scale(e).translate(n),s=!1}},t}var wait_for=function(t,e){t()?e():setTimeout(function(){wait_for(t,e)},100)};
function grph_axis_split(){function n(){}var t,r,e,i;return n.width=function(n){return 0===arguments.length?r:(r=n,this)},n.height=function(n){return 0===arguments.length?e:(e=n,this)},n.accept=function(n,t){var r=variable_schema(n,t);return"categorical"==r.type},n.variable=function(n){return 0===arguments.length?t:(t=n,this)},n.domain=function(n,r){if(0===arguments.length)return i;if(void 0===t)return this;var e=variable_schema(t,r);return i=e.categories.map(function(n){return n.name}),this},n.ticks=function(){return i},n.scale=function(n){return i.indexOf(n)},n}
function variable_schema(e,i){for(var r=0;r<i.fields.length;r++)if(i.fields[r].name==e)return i.fields[r];return void 0}
function grph_graph(n,t,r){var e,i,u,a;return r.axes=function(){return d3.keys(n)},r.width=function(n){return 0===arguments.length?e:(e=n,this)},r.height=function(n){return 0===arguments.length?i:(i=n,this)},r.accept=function(t,r){if(arguments.length>1)return void 0===n[r]?!1:n[r].accept(t,a);for(var e in n)if(void 0===t[e]){if(n[e].required)return!1}else{var i=n[e].accept(t[e],a);if(!i)return!1}return!0},r.assign=function(t){for(var r in n)n[r].variable(t[r]);return this},r.schema=function(n){return 0===arguments.length?a:(a=n,this)},r.data=function(n,t){return 0===arguments.length?u:(u=n,arguments.length>1&&r.schema(t),this)},r.dispatch=function(){return t},r}
function grph_graph_line(){var t={x:grph_axis_linear(!0),y:grph_axis_linear(!1),colour:grph_axis_colour(),column:grph_axis_split(),row:grph_axis_split()};t.x.required=!0,t.y.required=!0;var a={padding:[2,2,2,2],label_padding:4,sep:8,point_size:4},e=d3.dispatch("mouseover","mouseout","pointover","pointout"),l=d3.select("body").append("svg").attr("class","lineargraph dummy").style("visibility","invisible"),i=grph_label_size(l),r=grph_graph(t,e,function(l){function s(a){return t.colour.variable()?a[t.colour.variable()]:1}function n(a){return t.column.variable()?a[t.column.variable()]:1}function o(a){return t.row.variable()?a[t.row.variable()]:1}t.colour.domain(r.data(),r.schema()),t.column.domain(r.data(),r.schema()),t.row.domain(r.data(),r.schema());for(var c,d,h=t.column.variable()?t.column.ticks().length:1,p=t.row.variable()?t.row.ticks().length:1,u=variable_schema(t.x.variable(),schema),g=u.title,y=i.height(g)+a.label_padding,v=variable_schema(t.y.variable(),schema),x=v.title,m=0;2>m;++m)c=r.width()-a.padding[1]-a.padding[3]-t.y.width()-y,c=(c-(h-1)*a.sep)/h,t.x.width(c).domain(r.data(),r.schema()),d=r.height()-a.padding[0]-a.padding[2]-t.x.height()-y,d=(d-(p-1)*a.sep)/p,t.y.height(d).domain(r.data(),r.schema());var b=t.y.width()+a.padding[1]+y,f=a.padding[2],_=f+.5*(r.height()-a.padding[0]-a.padding[2]-t.x.height()-y),w=b+.5*(r.width()-a.padding[1]-a.padding[3]-t.y.width()-y);l.append("text").attr("x",a.padding[1]).attr("y",_).attr("text-anchor","middle").text(x).attr("transform","rotate(90 "+a.padding[1]+" "+_+")"),l.append("text").attr("x",w).attr("y",r.height()-a.padding[0]).attr("text-anchor","middle").text(g);var k=d3.nest().key(n).key(o).key(s).entries(r.data());for(m=0;m<k.length;++m){var A=k[m].values;f=a.padding[2];for(var z=0;z<A.length;++z){z==A.length-1&&l.append("g").attr("class","xaxis").attr("transform","translate("+b+","+(f+d)+")").call(t.x),0===m&&l.append("g").attr("class","xaxis").attr("transform","translate("+(b-t.y.width())+","+f+")").call(t.y);var q=l.append("g").attr("class","graph").attr("transform","translate("+b+","+f+")");q.append("rect").attr("class","background").attr("width",c).attr("height",d);var j=t.x.ticks();q.selectAll("line.gridx").data(j).enter().append("line").attr("class","grid gridx").attr("x1",t.x.scale).attr("x2",t.x.scale).attr("y1",0).attr("y2",d);var B=t.y.ticks();q.selectAll("line.gridy").data(B).enter().append("line").attr("class","grid gridy").attr("x1",0).attr("x2",c).attr("y1",t.y.scale).attr("y2",t.y.scale);var C=q.append("g").classed("crosshairs",!0);C.append("line").classed("hline",!0).attr("x1",0).attr("y1",0).attr("x2",t.x.width()).attr("y2",0).style("visibility","hidden"),C.append("line").classed("vline",!0).attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",t.y.height()).style("visibility","hidden");for(var D=d3.svg.line().x(t.x.scale).y(t.y.scale),E=A[z].values,F=0;F<E.length;++F)q.append("path").attr("d",D(E[F].values)).attr("class",t.colour.scale(E[F].key)).datum(E[F]);for(E=A[z].values,F=0;F<E.length;++F){q.selectAll("circle.circle"+F).data(E[F].values).enter().append("circle").attr("class","circle"+F+" "+t.colour.scale(E[F].key)).attr("cx",t.x.scale).attr("cy",t.y.scale).attr("r",a.point_size)}f+=t.y.height()+a.sep}b+=t.x.width()+a.sep}l.selectAll(".colour").on("mouseover",function(a){var i=t.colour.variable(),r=i?a.key||a[i]:void 0;e.mouseover.call(l,i,r,a),a.key||e.pointover.call(l,i,r,a)}),l.selectAll(".colour").on("mouseout",function(a){var i=t.colour.variable(),r=i?a.key||a[i]:void 0;e.mouseout.call(l,i,r,a),a.key||e.pointout.call(l,i,r,a)})});return e.on("mouseover",function(a,e){if(a){var l=t.colour.scale(""+e),i=/\bcolour([0-9]+)\b/,r=i.exec(l)[0];this.selectAll(".colour").classed("colourlow",!0),this.selectAll("."+r).classed({colourhigh:!0,colourlow:!1})}}),e.on("mouseout",function(){this.selectAll(".colour").classed({colourhigh:!1,colourlow:!1})}),e.on("pointover",function(a,e,l){this.selectAll(".hline").attr("y1",t.y.scale(l)).attr("y2",t.y.scale(l)).style("visibility","visible"),this.selectAll(".vline").attr("x1",t.x.scale(l)).attr("x2",t.x.scale(l)).style("visibility","visible")}),e.on("pointout",function(){this.selectAll(".hline").style("visibility","hidden"),this.selectAll(".vline").style("visibility","hidden")}),r}
function grph_graph_map(){var a={region:grph_axis_region(),colour:grph_axis_chloropleth(),column:grph_axis_split(),row:grph_axis_split()};a.region.required=!0,a.colour.required=!0;var e={padding:[2,2,2,2],label_padding:4,sep:8},r=d3.dispatch("mouseover","mouseout"),o=grph_graph(a,r,function(t){function l(e){return a.column.variable()?e[a.column.variable()]:1}function n(e){return a.row.variable()?e[a.row.variable()]:1}a.region.domain(o.data(),o.schema()),a.colour.domain(o.data(),o.schema()),a.column.domain(o.data(),o.schema()),a.row.domain(o.data(),o.schema());{var i=a.column.variable()?a.column.ticks().length:1,s=a.row.variable()?a.row.ticks().length:1,c=(o.width()-e.padding[1]-e.padding[3]-(i-1)*e.sep)/i,d=(o.height()-e.padding[0]-e.padding[2]-(s-1)*e.sep)/s,u=e.padding[1];e.padding[2]}a.region.width(c).height(d),wait_for(a.region.map_loaded,function(){for(var i=d3.nest().key(l).key(n).entries(o.data()),s=0;s<i.length;++s){for(var h=i[s].values,p=e.padding[2],g=0;g<h.length;++g){var m=svg.append("g").attr("class","graph").attr("transform","translate("+u+","+p+")");m.append("rect").attr("class","background").attr("width",c).attr("height",d),m.selectAll("path").data(h[g].values).enter().append("path").attr("d",a.region.scale).attr("class",a.colour.scale),p+=d+e.sep}u+=c+e.sep}t.selectAll("path").on("mouseover",function(e){var o=e[a.region.variable()];r.mouseover.call(t,a.region.variable(),o,e)}),t.selectAll("path").on("mouseout",function(e){var o=e[a.region.variable()];r.mouseout.call(t,a.region.variable(),o,e)})})});return r.on("mouseover.graph",function(a,e){this.selectAll("path").classed("colourlow",!0),this.selectAll("path").filter(function(r){return r[a]==e}).classed({colourhigh:!0,colourlow:!1})}),r.on("mouseout.graph",function(){this.selectAll("path").classed({colourhigh:!1,colourlow:!1})}),o}
function grph_label_size(t){function r(t){if(e[t])return e[t];if(!n)return[void 0,void 0];var r=n.append("text").text(t),i=r[0][0].getBBox(),u=[1.2*i.width,.65*i.height];return r.remove(),e[t]=u,u}var n=t,e={};return r.svg=function(t){return 0===arguments.length?n:(n=t,this)},r.width=function(t){var n=r(t);return n[0]},r.height=function(t){var n=r(t);return n[1]},r}
function grph_scale_chloropleth(){function r(r){if(void 0===n)return t+" "+t+"n1 "+t+1;var u=n[1]-n[0],e=Math.sqrt(.9999*(r-n[0]))/Math.sqrt(u),h=Math.floor(e*o);return t+" "+t+"n"+o+" "+t+(h+1)}var n,t="chloro",o=9;return r.domain=function(r){return 0===arguments.length?n:(n=r,this)},r.range=function(r){return 0===arguments.length?t:(t=r,this)},r.ticks=function(){for(var r=(n[1]-n[0])/o,t=n[0],u=[],e=0;o>=e;++e)u.push(t),t+=r;return u},r}
function grph_scale_colour(){function n(n){if(void 0===r)return u+" "+u+"n1 "+u+1;var e=r.indexOf(n);return u+" "+u+"n"+t+" "+u+(e+1)}var r,t,u="colour";return n.domain=function(n){return 0===arguments.length?r:(r=n,t=n.length,this)},n.range=function(n){return 0===arguments.length?u:(u=n,this)},n.ticks=function(){return r},n}
function grph_scale_linear(){function n(n){return e(n)}function i(n){var i="function"==typeof r?r(n):r;return i+=a}var t,e=d3.scale.linear(),r=20,a=5,l=10,u=!0;return n.domain=function(n){return n=e.domain(n),0===arguments.length?n:this},n.range=function(n){return n=e.range(n),0===arguments.length?n:this},n.label_size=function(n){return 0===arguments.length?r:(r=n,this)},n.nticks=function(n){return 0===arguments.length?l:(l=n,this)},n.inside=function(n){return 0===arguments.length?u:(u=n?!0:!1,this)},n.nice=function(){var n=e.range(),r=e.domain(),a=Math.abs(n[1]-n[0]),s=wilkinson_ii(r[0],r[1],l,i,a);if(u){var o=i(s.labels[0]),c=i(s.labels[s.labels.length-1]),g=o/2+c/2;s=wilkinson_ii(r[0],r[1],l,i,a-g),e.range(n[0]<n[1]?[n[0]+o/2,n[1]-c/2]:[n[0]-o/2,n[1]+c/2])}return domain=[s.lmin,s.lmax],e.domain([s.lmin,s.lmax]),t=s.labels,this},n.ticks=function(){return void 0===t?e.ticks(l):t},n}
function wilkinson_ii(r,t,e,n,i,o,a,l,s,f){function v(r,t,e,n,i,o){for(var a=e*i/(t-r),l=r;1e-10>=l-t;l+=e){var s=n(l,o);if(s>a)return!0}return!1}function c(r,t,e,o,a,l){a=a||[10,1,5,2,2.5,3,4,1.5,7,6,8,9],s=s||[1,0,0,0,-1,0,0,-1,0,0,0,0],l=l||.8,o=o||e;for(var f,c=e-1,u=(t-r)/c,h=Math.floor(Math.log(u)/Math.LN10),x=Math.pow(10,h),d=1-Math.abs(e-o)/o,m=0;m<a.length;m++){var p=a[m]*x,M=Math.floor(r/p)*p,g=M+c*p,b=h+s[m]<0?Math.abs(h+s[m]):0;if(r>=M&&g>=t){var N=1-(m-(0>=M&&g>=0))/a.length,w=(t-r)/(g-M);if(w>l&&!v(M,g,p,n,i,b)){var S=d+N+w;(void 0===f||S>f.score)&&(f={lmin:M,lmax:g,lstep:p,score:S,ndec:b})}}}return f}r=Number(r),t=Number(t),Math.abs(r-t)<1e-10&&(r=.96*r,t=1.04*t),n=n||function(){return 0},i=i||1,l=l||[10,1,5,2,2.5,3,4,1.5,7,6,8,9],s=s||[1,0,0,0,-1,0,0,-1,0,0,0,0],f=f||.8,o=o||2,a=a||Math.ceil(6*e);var u={lmin:r,lmax:t,lstep:t-r,score:-1e8,ndec:0},h=String(u.lstep).split(".");u.ndec=h.length>1?h[1].length:0;for(var x=o;a>=x;x++){var d=c(r,t,x,e,l,f);void 0!==d&&(void 0===u||d.score>u.score)&&(u=d)}for(var m=[],p=u.lmin;p-u.lmax<=1e-10;p+=u.lstep)m.push(p);return u.labels=m,u}format_numeric=function(r,t,e,n,i){if(isNaN(r))return"";if(void 0===t&&(t=""),void 0===n&&(n=","),void 0===i&&(i=" "),r=void 0!==e?r.toFixed(e):r.toString(),x=r.split("."),x1=x[0],x2=x.length>1?n+x[1]:"",""!==i)for(var o=/(\d+)(\d{3})/;o.test(x1);)x1=x1.replace(o,"$1"+i+"$2");return x1+x2+t};